
<script type="text/x-red" data-template-name="function">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row">
        <ul style="background: #fff;" id="function-node-tabs"></ul> 
    </div>

    <div id="function-node-tabs-content">

        <div id="function-node-tab-code" style="display:none">
            <div class="form-row" style="margin-bottom: 0px;">
                <label for="node-input-func"><i class="fa fa-wrench"></i> <span data-i18n="function.label.function"></span></label>
                <input type="hidden" id="node-input-func" autofocus="autofocus">
                <input type="hidden" id="node-input-noerr">
            </div>
            <div class="form-row node-text-editor-row" style="position:relative">
                <div style="position: absolute; right:0; bottom:calc(100% + 3px);"><button id="node-function-expand-js" class="editor-button editor-button-small"><i class="fa fa-expand"></i></button></div>
                <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-func-editor" ></div>
            </div>
            <div class="form-row">
                <label for="node-input-outputs"><i class="fa fa-random"></i> <span data-i18n="function.label.outputs"></span></label>
                <input id="node-input-outputs" style="width: 60px;" value="1">
            </div>
            <div class="form-tips"><span data-i18n="function.tip"></span></div>
        </div>

        <div id="function-node-tab-edit-params" style="display:none">
            <div class="node-row-params-edit">
                <div class="form-row params-edit-container-row">
                    <ol id="params-edit-container"></ol>
                </div>
            </div>
        </div>

        <div id="function-node-tab-input-params" style="display:none">
            <div class="for-row node-row-params-input">
                <div class="form-row" id="params-input-container"/>
            </div>
        </div>

    </div>
</script>

<script type="text/x-red" data-help-name="function">
    <p>A JavaScript function block to run against the messages being received by the node.</p>
    <p>The messages are passed in as a JavaScript object called <code>msg</code>.</p>
    <p>By convention it will have a <code>msg.payload</code> property containing
       the body of the message.</p>
    <p>The function is expected to return a message object (or multiple message objects), but can choose
       to return nothing in order to halt a flow.</p>
    <h3>Details</h3>
    <p>See the <a target="_blank" href="http://nodered.org/docs/writing-functions.html">online documentation</a>
    for more information on writing functions.</p>
    <h4>Sending messages</h4>
    <p>The function can either return the messages it wants to pass on to the next nodes
    in the flow, or can call <code>node.send(messages)</code>.</p>
    <p>It can return/send:</p>
    <ul>
      <li>a single message object - passed to nodes connected to the first output</li>
      <li>an array of message objects - passed to nodes connected to the corresponding outputs</li>
    </ul>
    <p>If any element of the array is itself an array of messages, multiple
          messages are sent to the corresponding output.</p>
    <p>If null is returned, either by itself or as an element of the array, no
          message is passed on.</p>
    <h4>Logging and Error Handling</h4>
    <p>To log any information, or report an error, the following functions are available:</p>
      <ul>
          <li><code>node.log("Log message")</code></li>
          <li><code>node.warn("Warning")</code></li>
          <li><code>node.error("Error")</code></li>
      </ul>
    </p>
    <p>The Catch node can also be used to handle errors. To invoke a Catch node,
    pass <code>msg</code> as a second argument to <code>node.error</code>:</p>
    <pre>node.error("Error",msg);</pre>
    <h4>Referring Node Information</h4>
    <p>In the function block, id and name of the node can be referenced using the following properties:</p>
    <ul>
        <li><code>node.id</code> - id of the node</li>
        <li><code>node.name</code> - name of the node</li>
    </ul>
</script>

<script type="text/javascript">
    RED.nodes.registerType('function',{
        color:"#fdd0a2",
        category: 'function',
        defaults: {
            name: {value:""},
            func: {value:"\nreturn msg;"},
            outputs: {value:1},
            noerr: {value:0,required:true,validate:function(v) { return ((!v) || (v === 0)) ? true : false; }},
            displayMode: {value: "edit"},
            params: {value: []},
	    active_tab: {value: "function-node-tab-code"}
        },
        inputs:1,
        outputs:1,
        icon: "function.png",
        label: function() {
            return this.name||this._("function.function");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var that = this;

            function setupInputUI() {
                var container = $("#params-input-container");
                var rules = $("#params-edit-container").editableList('items');
                container.empty();
                rules.each(function (i) {
                    var label = $(this).find(".params-label").val();
                    var ti = $(this).find(".params-value");
                    var type = ti.typedInput("type");
                    var value = ti.typedInput("value");
                    var row = $("<div/>", {
			class: "form-row",
			f_label: label,
			f_type: type,
			f_value: value
		    }).appendTo(container);
                    var labelField = $("<label/>", {
			style: "width: 25%; padding-left: 10px;"
		    }).html(label).appendTo(row);
		    if ((type === 'str') || (type === 'num') ||
			(type === 'bool') || (type === 'date') ||
			(type === 're') || (type === 'json') ||
			(type === 'bin') || (type === 'jsonata') ||
			(type === 'env')
		       ) {
                        var valueField = $("<input/>", {
			    type: "text",
			    style: "width: 70%;"
			})
			    .appendTo(row)
			    .typedInput({
				default: type,
				types: [ type ]
			    });
			valueField.typedInput("value", value);
			valueField.on("change", function (e, t) {
			    var new_val = valueField.typedInput("value");
			    ti.typedInput("value", new_val);
			});
		    }
		    else if (type === 'checkbox') {
                        var valueField = $("<input/>", {type: "checkbox"})
			    .appendTo(row)
			valueField.prop("checked", value);
		    }
		    else if (type === 'button') {
		    }
		    else if (type === 'menu') {
		    }
		    else if (type === 'label') {
			// nothing to do
		    }
		    else {
			throw new Error("unexpected field type");
		    }
                });
	    }
	    
            function setupTabs() {
                var tabs = RED.tabs.create({
                    id: "function-node-tabs",
                    onchange: function(tab) {
			if (tab.id === 'function-node-tab-input-params') {
			    setupInputUI();
			}
                        $("#function-node-tabs-content").children().hide();
                        $("#" + tab.id).show();
			that.active_tab = tab.id;
                    }
                });
                tabs.addTab({
                    id: "function-node-tab-code",
                    label: "Code"
                });
                tabs.addTab({
                    id: "function-node-tab-edit-params",
                    label: "Edit Parameters"
                });
                tabs.addTab({
                    id: "function-node-tab-input-params",
                    label: "Input Parameters"
                });
            } // setupTabs

            function setupCodeTab() {
                $( "#node-input-outputs" ).spinner({
                    min:1,
                    change: function(event, ui) {
                        var value = this.value;
                        if (!value.match(/^\d+$/)) { value = 1;  }
                        else if (value < this.min) { value = this.min; }
                        if (value !== this.value) { $(this).spinner("value", value); }
                    }
                });

                that.editor = RED.editor.createEditor({
                    id: 'node-input-func-editor',
                    mode: 'ace/mode/javascript',
                    value: $("#node-input-func").val(),
                    globals: {
                        msg:true,
                        context:true,
                        RED: true,
                        util: true,
                        flow: true,
                        global: true,
                        console: true,
                        Buffer: true,
                        setTimeout: true,
                        clearTimeout: true,
                        setInterval: true,
                        clearInterval: true
                    }
                });

                RED.library.create({
                    url:"functions", // where to get the data from
                    type:"function", // the type of object the library is for
                    editor:that.editor, // the field name the main text body goes to
                    mode:"ace/mode/javascript",
                    fields:['name','outputs']
                });
                that.editor.focus();

                $("#node-function-expand-js").click(function(e) {
                    e.preventDefault();
                    var value = that.editor.getValue();
                    RED.editor.editJavaScript({
                        value: value,
                        cursor: that.editor.getCursorPosition(),
                        complete: function(v,cursor) {
                            that.editor.setValue(v, -1);
                            that.editor.gotoLine(cursor.row+1,cursor.column,false);
                            setTimeout(function() {
                                that.editor.focus();
                            },300);
                        }
                    })
                });
            } // setupCodeTab

            function setupParamsTab() {
                var checkboxType = {
                    value: "checkbox",
                    label: "checkbox",
                    icon: "fa fa-check-square-o",
                    hasValue: false
                };
                var buttonType = {
                    value: "button",
                    label: "button",
                    icon: "fa fa-hand-pointer-o",
                    hasValue: false
                };
                var menuType = {
                    value: "menu",
                    label: "menu",
                    icon: "fa fa-list",
                    hasValue: false
                };
                var labelType = {
                    value: "label",
                    label: "label",
		    icon: "fa fa-tag",
                    hasValue: false
                };
                $("#params-edit-container")
                    .css('min-height','250px')
                    .css('min-width','400px')
                    .editableList({
                        addItem: function(container,i,opt) {
                            var row = $('<div/>').appendTo(container);
                            var labelField = $('<input/>',{
                                class: "params-label",
                                type: "text",
                                style: "width:37%; margine-left:5px;",
                                placeholder: "name"
                            }).appendTo(row);
			    if (opt && opt.label) {
				labelField.val(opt.label);
			    }
			    var type =
				(opt && opt.hasOwnProperty("type")) ? opt.type : "str";
                            var valueField = $('<input/>', {
                                class: "params-value",
                                type: "text",
                                style: "width:60%; margin-left:5px;"
                            }).appendTo(row)
                                .typedInput({
                                    default: type,
                                    types: ['str', 'num', 'bool', 'date', 're',
                                            'json', 'bin', 'jsonata', 'env',
                                            checkboxType,
                                            buttonType,
                                            menuType,
                                            labelType
                                           ]
                                });
			    if (opt && opt.value) {
				valueField.val(opt.value);
			    }
                        },
                        removeItem: function(opt) {
                        },
                        removable: true,
			sortable: true
                    });

		var params = that.params;
		console.log("; Params:", params);
                var container = $("#params-edit-container");
                container.editableList('empty');
                for (var i = 0; i < params.length; i++) {
                    var param = params[i];
		    console.log("; add: ", param);
                    container.editableList('addItem', {
			label: param.label,
                        type: param.type,
                        value: param.value
                    });
                }
            } // setupParamsTab

            setupTabs();
            setupCodeTab();
            setupParamsTab();
        },
        oneditsave: function() {
	    var that = this;

	    function saveParams() {
		var params = [];
                var rules = $("#params-edit-container").editableList('items');
                rules.each(function (i) {
                    var label = $(this).find(".params-label").val();
                    var ti = $(this).find(".params-value");
                    var type = ti.typedInput("type");
                    var value = ti.typedInput("value");
		    params.push({index: i, label: label, type: type, value: value});
		});
		that.params = params;
	    } // saveParams

            var annot = that.editor.getSession().getAnnotations();
            that.noerr = 0;
            $("#node-input-noerr").val(0);
            for (var k=0; k < annot.length; k++) {
                //console.log(annot[k].type,":",annot[k].text, "on line", annot[k].row);
                if (annot[k].type === "error") {
                    $("#node-input-noerr").val(annot.length);
                    that.noerr = annot.length;
                }
            }
            $("#node-input-func").val(that.editor.getValue());
	    saveParams();

            that.editor.destroy();
            delete that.editor;
        },
        oneditcancel: function() {
            this.editor.destroy();
            delete this.editor;
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-text-editor-row)");
            var height = $("#dialog-form").height();
            for (var i=0; i<rows.size(); i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-text-editor-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
            $(".node-text-editor").css("height",height+"px");
            this.editor.resize();
        }
    });
</script>

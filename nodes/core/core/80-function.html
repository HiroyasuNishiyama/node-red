<!--
  Copyright JS Foundation and other contributors, http://js.foundation
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-template-name="function">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row">
        <ul style="background: #fff;" id="function-node-tabs"></ul> 
    </div>

    <div id="function-node-tabs-content">

        <div id="function-node-tab-edit-code" style="display:none">
            <div class="form-row" style="margin-bottom: 0px;">
                <label for="node-input-func"><i class="fa fa-wrench"></i> <span data-i18n="function.label.function"></span></label>
                <input type="hidden" id="node-input-func" autofocus="autofocus">
                <input type="hidden" id="node-input-noerr">
            </div>
            <div class="form-row node-text-editor-row" style="position:relative">
                <div style="position: absolute; right:0; bottom:calc(100% + 3px);"><button id="node-function-expand-js" class="editor-button editor-button-small"><i class="fa fa-expand"></i></button></div>
                <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-func-editor" ></div>
            </div>
            <div class="form-row">
                <label for="node-input-outputs"><i class="fa fa-random"></i> <span data-i18n="function.label.outputs"></span></label>
                <input id="node-input-outputs" style="width: 60px;" value="1">
            </div>
            <div class="form-tips"><span data-i18n="function.tip"></span></div>
        </div>

        <div id="function-node-tab-edit-params" style="display:none">
            <div class="node-row-params-edit">
                <div class="form-row params-edit-container-row">
                    <ol id="params-edit-container"></ol>
                </div>
            </div>
        </div>

        <div id="function-node-tab-input-params" style="display:none">
            <div class="form-row node-row-params-input">
                <div class="form-row" id="params-input-container"/>
            </div>
        </div>

    </div>
</script>

<script type="text/x-red" data-help-name="function">
    <p>A JavaScript function block to run against the messages being received by the node.</p>
    <p>The messages are passed in as a JavaScript object called <code>msg</code>.</p>
    <p>By convention it will have a <code>msg.payload</code> property containing
       the body of the message.</p>
    <p>The function is expected to return a message object (or multiple message objects), but can choose
       to return nothing in order to halt a flow.</p>
    <h3>Details</h3>
    <p>See the <a target="_blank" href="http://nodered.org/docs/writing-functions.html">online documentation</a>
    for more information on writing functions.</p>
    <h4>Sending messages</h4>
    <p>The function can either return the messages it wants to pass on to the next nodes
    in the flow, or can call <code>node.send(messages)</code>.</p>
    <p>It can return/send:</p>
    <ul>
      <li>a single message object - passed to nodes connected to the first output</li>
      <li>an array of message objects - passed to nodes connected to the corresponding outputs</li>
    </ul>
    <p>If any element of the array is itself an array of messages, multiple
          messages are sent to the corresponding output.</p>
    <p>If null is returned, either by itself or as an element of the array, no
          message is passed on.</p>
    <h4>Logging and Error Handling</h4>
    <p>To log any information, or report an error, the following functions are available:</p>
      <ul>
          <li><code>node.log("Log message")</code></li>
          <li><code>node.warn("Warning")</code></li>
          <li><code>node.error("Error")</code></li>
      </ul>
    </p>
    <p>The Catch node can also be used to handle errors. To invoke a Catch node,
    pass <code>msg</code> as a second argument to <code>node.error</code>:</p>
    <pre>node.error("Error",msg);</pre>
    <h4>Referring Node Information</h4>
    <p>In the function block, id and name of the node can be referenced using the following properties:</p>
    <ul>
        <li><code>node.id</code> - id of the node</li>
        <li><code>node.name</code> - name of the node</li>
    </ul>
</script>

<script type="text/javascript">
(function () {
    var _count = 0;

    function saveParams(node) {
        var params = [];
        var rules = $("#params-edit-container").editableList("items");
        rules.each(function (i, item) {
            var label = $(item).find(".params-label").val();
            var ti = $(item).find(".params-value");
            var type = ti.typedInput("type");
            if ((type === "msg") ||
                (type === "flow") || (type === "global") ||
                (type === "str") || (type === "num") ||
                (type === "bool") || (type === "date") ||
                (type === "re") || (type === "json") ||
                (type === "bin") || (type === "jsonata") ||
                (type === "env") ||
                (type === "checkbox")
               ) {
                var value = ti.typedInput("value");
                params.push({
                    index: i, label: label,
                    type: type, value: value, items: undefined,
                    any_type: undefined
                });
            }
            else if (type === "menu") {
                var value = ti.typedInput("value");
                var items = $(item).find(".menu-item-list").editableList("items");
                var menu_items = [];
                items.each(function (i, item) {
                    var item = $(item).find(".menu-item").val();
                    menu_items.push(item);
                });
                params.push({
                    index: i, label: label,
                    type: type, value: value, items: menu_items,
                    any_type: undefined
                });
            }
            else if (type === "any") {
                var value = ti.typedInput("value");
                var types = $(item).find(".type-selector");
                var selected = [];
                types.each(function (i, type) {
                    if($(type).prop("checked")) {
                        var name = $(type).prop("value");
                        selected.push(name);
                    }
                });
                var any_type = (selected.length > 0) ? selected[0] : "undef";
                params.push({
                    index: i, label: label,
                    type: "any", value: value, items: selected,
                    any_type: any_type
                });
            }
            else if (type === "label") {
                params.push({
                    index: i, label: label,
                    type: type, value: "", items: undefined ,
                    any_type: undefined
                });
            }
            else {
                throw new Error("unexpected field type: "+JSON.stringify(type));
            }
        });
        node.func_params = params;
    } // saveParams
    
    RED.nodes.registerType('function',{
        color:"#fdd0a2",
        category: 'function',
        defaults: {
            name: {value:""},
            func: {value:"\nreturn msg;"},
            outputs: {value:1},
            noerr: {value:0,required:true,validate:function(v) { return ((!v) || (v === 0)) ? true : false; }},
            func_params: {value: []},
            active_tab: {value: "function-node-tab-edit-code"}
        },
        inputs:1,
        outputs:1,
        icon: "function.png",
        label: function() {
            return this.name||this._("function.function");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var that = this;

            function setupInputUI(node) {
                var params = node.func_params;
                var container = $("#params-input-container");
                container.empty();
                params.forEach(function (item) {
                    var label = item.label;
                    var type = item.type;
                    var value = item.value;
                    var row0 = $("<div/>", {
                        class: "form-row",
                        style: "padding-left: 20px;"
                    }).appendTo(container);
                    if ((type === "msg") ||
                        (type === "flow") || (type === "global") ||
                        (type === "str") || (type === "num") ||
                        (type === "bool") || (type === "date") ||
                        (type === "re") || (type === "json") ||
                        (type === "bin") || (type === "jsonata") ||
                        (type === "env")
                       ) {
                        var labelField = $("<label/>", {
                            style: "width: 25%;"
                        }).html(label).appendTo(row0);
                        var valueField = $("<input/>", {
                            type: "text",
                            style: "width: 70%;"
                        })
                            .appendTo(row0)
                            .typedInput({
                                default: type,
                                types: [ type ]
                            });
                        valueField.typedInput("value", value);
                        valueField.on("change", function (e, t) {
                            var new_val = valueField.typedInput("value");
                            item.value = new_val;
                        });
                    }
                    else if (type === "any") {
                        var undefType = {
                            value: "undef",
                            label: "undef",
                            icon: "fa fa-question",
                            hasValue: false
                        };
                        var any_type = item.any_type;
                        var items = item.items;
                        var labelField = $("<label/>", {
                            style: "width: 25%;"
                        }).html(label).appendTo(row0);
                        var types = ((any_type === "undef") ? [undefType] : items);
                        var valueField = $("<input/>", {
                            type: "text",
                            style: "width: 70%;"
                        })
                            .appendTo(row0)
                            .typedInput({
                                default: any_type,
                                types: types
                            });
                        valueField.typedInput("value", value);
                        valueField.on("change", function (e, t) {
                            var new_type = valueField.typedInput("type");
                            var new_val = valueField.typedInput("value");
                            item.any_type = new_type;
                            item.value = new_val;
                        });
                    }
                    else if (type === "checkbox") {
                        var padding = $("<label/>", {
                            style: "width: 25%;"
                        }).html("").appendTo(row0);
                        var valueField = $("<input/>", {
                            type: "checkbox",
                            style: "display: inline-block; width: auto; vertical-align: top;"
                        }).appendTo(row0)
                        var labelField = $("<label/>", {
                            style: "width: auto; margin-left: 10px;"
                        }).appendTo(row0);
                        labelField.html(label);
                        valueField.prop("checked", value);
                        valueField.on("change", function (e, t) {
                            var new_val = valueField.prop("checked");
                            item.value = new_val;
                        });
                    }
                    else if (type === "menu") {
                        var labelField = $("<label/>", {
                            style: "width: 25%;"
                        }).html(label).appendTo(row0);
                        var items = item.items;
                        var selector = $("<select/>", {
                            class: "menu-selector"
                        }).appendTo(row0);
                        items.forEach(function (val) {
                            $("<option>", {
                                value: val
                            }).text(val).appendTo(selector);
                        });
                        selector.change(function () {
                            var val = selector.val();
                            item.value = val;
                        });
                        if (value) {
                            selector.val(value);
                        }
                        selector.change();
                    }
                    else if (type === "label") {
                        var labelField = $("<label/>", {
                        }).html(label).appendTo(row0);
                    }
                    else {
                        throw new Error("unexpected field type");
                    }
                });
            } // setupInputUI

            function loadParams(node) {
                var rules = $("#params-edit-container").editableList("items");
                var params = node.func_params;
                for (var i = 0; i < params.length; i++) {
                    var param = params[i];
                    var rule = rules[i];
                    var type = param.type;
                    var value = param.value;
                    var ti = $(rule).find(".params-value");
                    ti.typedInput("value", value);
                    ti.typedInput("type", type);
                    if (type === "any") {
                        var items = param.items;
                        var selectors = $(rule).find(".type-selector");
                        selectors.each(function (i, sel) {
                            var value = $(sel).prop("value");
                            if (items.indexOf(value) >= 0) {
                                $(sel).prop("checked", true);
                            }
                        });
                    }
                }
            } // loadParams

            function setupTabs() {
                var tabs = RED.tabs.create({
                    id: "function-node-tabs",
                    onchange: function(tab) {
                        $("#function-node-tabs-content").children().hide();
                        $("#" + tab.id).show();
                        if (that.active_tab === "function-node-tab-edit-params") {
                            saveParams(that);
                        }
                        if ((that.active_tab === "function-node-tab-input-params") &&
                            (tab.id === "function-node-tab-edit-params")) {
                        }
                        if (tab.id === "function-node-tab-edit-params") {
                            loadParams(that);
                        }
                        if (tab.id === "function-node-tab-input-params") {
                            setupInputUI(that);
                        }
                        if ((tab.id === "function-node-tab-edit-code") &&
                            that.active_tab) {
                            var code = $("#node-input-func").val();
                            if (that.editor) {
                                var val = that.editor.getValue();
                                if (!that.editor_init) {
                                    that.editor.setValue(val);
                                    that.editor.clearSelection();
                                    that.editor_init = true;
                                }
                                that.editor.focus();
                            }
                        }
                        that.active_tab = tab.id;
                    }
                });
                tabs.addTab({
                    id: "function-node-tab-edit-code",
                    label: "Edit Code"
                });
                tabs.addTab({
                    id: "function-node-tab-edit-params",
                    label: "Edit Parameters"
                });
                tabs.addTab({
                    id: "function-node-tab-input-params",
                    label: "Input Parameters"
                });
                return tabs;
            } // setupTabs

            function setupCodeTab() {
                $( "#node-input-outputs" ).spinner({
                    min:1,
                    change: function(event, ui) {
                        var value = this.value;
                        if (!value.match(/^\d+$/)) { value = 1;  }
                        else if (value < this.min) { value = this.min; }
                        if (value !== this.value) { $(this).spinner("value", value); }
                    }
                });

                that.editor = RED.editor.createEditor({
                    id: 'node-input-func-editor',
                    mode: 'ace/mode/javascript',
                    value: $("#node-input-func").val(),
                    globals: {
                        msg:true,
                        context:true,
                        RED: true,
                        util: true,
                        flow: true,
                        global: true,
                        console: true,
                        Buffer: true,
                        setTimeout: true,
                        clearTimeout: true,
                        setInterval: true,
                        clearInterval: true
                    }
                });

                RED.library.create({
                    url:"functions", // where to get the data from
                    type:"function", // the type of object the library is for
                    editor:that.editor, // the field name the main text body goes to
                    mode:"ace/mode/javascript",
                    fields:['name','outputs']
                });
                that.editor.focus();

                $("#node-function-expand-js").click(function(e) {
                    e.preventDefault();
                    var value = that.editor.getValue();
                    RED.editor.editJavaScript({
                        value: value,
                        cursor: that.editor.getCursorPosition(),
                        complete: function(v,cursor) {
                            that.editor.setValue(v, -1);
                            that.editor.gotoLine(cursor.row+1,cursor.column,false);
                            setTimeout(function() {
                                that.editor.focus();
                            },300);
                        }
                    })
                });
            } // setupCodeTab

            function setupParamsTab() {
                function setupContainer(cont) {
                    var anyType = {
                        value: "any",
                        label: "any",
                        icon: "fa fa-cog",
                        hasValue: true
                    };
                    var checkboxType = {
                        value: "checkbox",
                        label: "checkbox",
                        icon: "fa fa-check-square-o",
                        hasValue: false
                    };
                    var menuType = {
                        value: "menu",
                        label: "menu",
                        icon: "fa fa-list",
                        hasValue: false
                    };
                    var labelType = {
                        value: "label",
                        label: "label",
                        icon: "fa fa-tag",
                        hasValue: false
                    };
                    cont
                        .css("min-height", "250px")
                        .css("min-width", "400px")
                        .editableList({
                            addItem: function (container0, i, opt) {
                                function setupMenuItems(row, val, items) {
                                    var menu = $("<ol/>", {
                                        class: "menu-item-list"
                                    }).appendTo(row);
                                    menu
                                        .css("min-height", "120px")
                                        .editableList({
                                            addItem: function (con, i, opt) {
                                                var row = $("<div/>").appendTo(con);
                                                var field = $("<input/>", {
                                                    class: "menu-item",
                                                    type: "text",
                                                    style: "width: 95%;"
                                                }).appendTo(row);
                                                if (opt.value) {
                                                    field.val(opt.value);
                                                }
                                            },
                                            removeItem: function (opt) {
                                            },
                                            removable: true,
                                            sortable: true
                                        });
                                    if (items) {
                                        for(var i = 0; i < items.length; i++) {
                                            var item = items[i];
                                            menu.editableList("addItem", {
                                                value: item
                                            });
                                        }
                                    }
                                } // setupMenuItems

                                function setupTypeSelector(row) {
                                    var type_map = {
                                        "msg" : {
                                            label: "msg."
                                        },
                                        "flow" : {
                                            label: "flow."
                                        },
                                        "global" : {
                                            label: "global."
                                        },
                                        "str" : {
                                            label: "string",
                                            icon: "red/images/typedInput/az.png"
                                        },
                                        "num" : {
                                            label: "number",
                                            icon: "red/images/typedInput/09.png"
                                        },
                                        "bool" : {
                                            label: "bool",
                                            icon: "red/images/typedInput/bool.png"
                                        },
                                        "date" : {
                                            label: "timestamp"
                                        },
                                        "re" : {
                                            label: "reg. exp.",
                                            icon: "red/images/typedInput/re.png"
                                        },
                                        "json" : {
                                            label: "json",
                                            icon: "red/images/typedInput/json.png"
                                        },
                                        "bin" : {
                                            label: "buffer",
                                            icon: "red/images/typedInput/bin.png"
                                        },
                                        "jsonata" : {
                                            label: "jsonata",
                                            icon: "red/images/typedInput/expr.png"
                                        },
                                        "env" : {
                                            label: "env",
                                            icon: "red/images/typedInput/env.png"
                                        }
                                    };
                                    var types = Object.keys(type_map);
                                    var div0 = null;
                                    var count = 0;
                                    types.forEach(function (type) {
                                        if((count % 3) === 0) {
                                            div0 = $("<div/>", {
                                                style: "margin-left: 10px;"
                                            }).appendTo(row);
                                        }
                                        var item = type_map[type];
                                        var label = item.label;
                                        var icon = item.icon;
                                        var div1 = $("<div/>", {
                                            style: "display: inline-block; width: 113px;"
                                        }).appendTo(div0);
                                        var div2 = $("<div/>", {
                                            style: "display: inline-block; width: 40px;"
                                        }).appendTo(div1);
                                        $("<input/>", {
                                            type: "checkbox",
                                            name: "type",
                                            value: type,
                                            class: "type-selector",
                                            id: type +"_" +_count,
                                            style: "width: auto; margin-left: 5px; margin-right: 5px;"
                                        }).appendTo(div2);
                                        if (icon) {
                                            $("<img/>", {
                                                src: icon,
                                                style: "width: auto; margin-right: 4px; height: 18px;"
                                            }).appendTo(div2);
                                        }
                                        $("<label/>", {
                                            for: type +"_" +_count,
                                            style: "width: auto;"
                                        }).text(label).appendTo(div1);
                                        count++;
                                        _count++;
                                    });
                                } // setupTypeSelector
                                
                                var row0 = $("<div/>").appendTo(container0);
                                var row1 = $("<div/>", {
                                    class: "menu-selection-list",
                                    style: "width: 60%; min-height: 100px; margin-top: 10px; margin-left: auto; margin-right: 7px;"
                                }).appendTo(container0);
                                var row2 = $("<div/>").appendTo(container0);
                                var labelField = $("<input/>", {
                                    class: "params-label",
                                    type: "text",
                                    style: "width:37%; margine-left:5px;",
                                    placeholder: "name"
                                }).appendTo(row0);
                                if (opt && opt.label) {
                                    labelField.val(opt.label);
                                }
                                var type = (opt && opt.hasOwnProperty("type")) ? opt.type : "str";
                                var valueField = $("<input/>", {
                                    class: "params-value",
                                    type: "text",
                                    style: "width:60%; margin-left:5px;"
                                }).appendTo(row0)
                                    .typedInput({
                                        default: type,
                                        types: ["msg", "flow", "global",
                                                "str", "num", "bool", "date", "re",
                                                "json", "bin", "jsonata", "env",
                                                checkboxType,
                                                menuType,
                                                labelType,
                                                anyType
                                               ]
                                    });
                                if (opt && opt.value) {
                                    valueField.typedInput("value", opt.value);
                                }

                                setupMenuItems(row1, opt.value, opt.items);
                                setupTypeSelector(row2);

                                valueField.change(function () {
                                    var type = valueField.typedInput("type");
                                    row1.toggle(type === "menu");
                                    row2.toggle(type === "any");
                                });
                                valueField.change();
                            },
                            removeItem: function (opt) {
                            },
                            removable: true,
                            sortable: true
                        });
                } // setupContainer
                
                var edit_con = $("#params-edit-container");
                setupContainer(edit_con);
                edit_con.editableList("empty");
                var params = that.func_params || [];
                for (var i = 0; i < params.length; i++) {
                    var param = params[i];
                    edit_con.editableList("addItem", {
                        label: param.label,
                        type: param.type,
                        value: param.value,
                        items: param.items
                    });
                }
            } // setupParamsTab

            var active_tab = that.active_tab;
            that.active_tab = undefined;
            that.editor_init = false;
            var tabs = setupTabs();
            setupCodeTab();
            setupParamsTab();
            if (active_tab) {
                tabs.activateTab(active_tab);
            }
        },
        oneditsave: function() {
            var that = this;
            var annot = that.editor.getSession().getAnnotations();
            that.noerr = 0;
            $("#node-input-noerr").val(0);
            for (var k=0; k < annot.length; k++) {
                //console.log(annot[k].type,":",annot[k].text, "on line", annot[k].row);
                if (annot[k].type === "error") {
                    $("#node-input-noerr").val(annot.length);
                    that.noerr = annot.length;
                }
            }
            $("#node-input-func").val(that.editor.getValue());
            if (that.active_tab === "function-node-tab-edit-params") {
                saveParams(that);
            }

            that.editor.destroy();
            delete that.editor;
        },
        oneditcancel: function() {
            this.editor.destroy();
            delete this.editor;
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-text-editor-row)");
            var height = $("#dialog-form").height();
            for (var i=0; i<rows.size(); i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-text-editor-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
            $(".node-text-editor").css("height",height+"px");
            this.editor.resize();
        }
    });
})();
</script>
